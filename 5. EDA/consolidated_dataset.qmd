---
title: "EDA Consolidated Dataset"
format: html
editor: visual
---

## Quarto

This file provided an exploration of the consolidated dataset

```{r}
library(tidyverse)
library(here)
```

```{r}
dataset <- read_csv(here("4. Data","consolidated.csv"))

```

```{r}
non_predictors <- c("Year","census_years","StateAb","DivisionNm","PartyAb","Percentage_Diff_National")
  
just_predictors <- dataset |> 
                  select(-Percentage_Diff_National,-PartyAb) |>
                  distinct() |>
                  mutate(unique_name = str_c(DivisionNm,"-",Year)) |> 
                  column_to_rownames(var="unique_name") |>
                  select(-any_of(c(non_predictors,"unique_name")))
                  #select(-any_of(non_predictors))


visdat::vis_cor(just_predictors)
```

Unsurpringsily, very strong correlation between:

-   Religion - Islam and Language - Arabic - keeping language instad of religion

-   Religion- Hinduism and Laguage - South Asian

-   Religion - Buddihsm and Language - East Asian - keeping language group instead of religion.

Question - is religion important in australian politics. Converserly no - but it seems alignment between Anglican-Presbyterian-Baptist with Coalition and Catholicism with Labor. There are historical reasons (e.g. Irish Catholics involved in labour movements) and there are a proxy for other groups (e.g. rural, anglo-celtic australians voting for National party)

```{r}
dataset <- dataset |>
          select(-`Rel - Islam`,
                  -`Rel - Hinduism`,
                  -`Rel - Buddhism`)

just_predictors <- just_predictors |>
          select(-`Rel - Islam`,
                  -`Rel - Hinduism`,
                  -`Rel - Buddhism`)
```

# Principal component analysis?

```{r}
pca <- FactoMineR::PCA(just_predictors |> drop_na(), ncp=10)
```

```{r}

```

```{r}

```

```{r}
factoextra::fviz_screeplot(pca)
```

```{r}
pca$eig
```

```{r}
factoextra::fviz_pca_contrib(pca, choice="var", axes = 1, top = 15)
```

```{r}
factoextra::fviz_pca_biplot(pca,c(1,2),geom="point")
```

```{r}
factoextra::fviz_pca_contrib(pca, choice="var", axes = 2, top = 15)
```

```{r}
factoextra::fviz_pca_biplot(pca,c(1,2),geom="point")
```

```{r}
```

```{r}
factoextra::fviz_pca_contrib(pca, choice="var", axes = 3, top = 15)
```

```{r}
factoextra::fviz_pca_biplot(pca,c(2,3),geom="point")
```

```{r}
factoextra::fviz_pca_contrib(pca, choice="var", axes = 4, top = 15)

```

```{r}
factoextra::fviz_pca_biplot(pca,c(3,4),geom="point")
```

```{r}
factoextra::fviz_pca_contrib(pca, choice="var", axes = 5, top = 15)
```

```{r}
factoextra::fviz_pca_contrib(pca, choice="var", axes = 6, top = 15)
```

```{r}
factoextra::fviz_pca_var(pca,c(5,6))
```

```{r}

pca$var
```

```{r}
factoextra::fviz_pca_contrib(pca, choice="var", axes = 7, top = 15)
```

```{r}
factoextra::fviz_pca_contrib(pca, choice="var", axes = 8, top = 15)
```

```{r}
factoextra::fviz_pca_contrib(pca, choice="var", axes = 9, top = 15)
```

```{r}
factoextra::fviz_pca_contrib(pca, choice="var", axes = 10, top = 15)
```

```{r}
factoextra::fviz_pca_ind(pca, col.ind = "cos2", 
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE # Avoid text overlapping (slow if many points)
             )

```

```{r}
factoextra::fviz_pca_ind(pca, col.ind = "cos2",
                         axes=c(3,4),
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE # Avoid text overlapping (slow if many points)
             )
```

```{r}

```

```{r}
factoextra::fviz_pca_ind(pca, col.ind = "cos2",
                         axes=c(4,5),
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE # Avoid text overlapping (slow if many points)
             )
```

```{r}
transformed <- 
```

```{r}

p <- list()
for(dim in str_c("Dim.",1:10)){

p[[length(p)+1]] <- pca$ind$contrib |> 
  as_tibble(rownames="unique_id") |>
  separate(unique_id,c("DivisionNm","Year"),"-") |>
  mutate(Year = as.numeric(Year)) |>
  left_join(dataset |> select(any_of(non_predictors)),
            by=c("DivisionNm","Year")) |>
  filter(!is.na(Percentage_Diff_National))|>
  select(any_of(c("PartyAb","Percentage_Diff_National")),contains("Dim")) |>
  pivot_longer(-c("PartyAb","Percentage_Diff_National"),names_to="Dim",values_to = "value") |>
  filter(Dim==dim) |>
  mutate(Percentage_Diff_National=sqrt(Percentage_Diff_National)*sign(Percentage_Diff_National)) |>
  ggplot(aes(x=PartyAb,y=value,colour=Percentage_Diff_National)) +
  geom_point() +
  theme(legend.position = "none") +
  scale_colour_gradient2(mid="yellow") +
  labs(subtitle=dim)
  
  }
  
p[[length(p)]] <- p[[length(p)]] + theme(legend.position = "bottom")

patchwork::wrap_plots(p,ncol=3)

```

```{r}
db <- dbscan::dbscan(transformed |> select(-any_of(c(non_predictors,"unique_id"))),eps = 0.2, minPts = 4)

db
```

```{r}
transformed$cluster <- db$cluster

p <- list()
for(dim in str_c("Dim.",1:10)){
 p[[length(p)+1]] <-  transformed |>
 separate(unique_id,c("DivisionNm","Year"),"-") |>
  mutate(Year = as.numeric(Year)) |>
  left_join(dataset |> select(any_of(non_predictors)),
            by=c("DivisionNm","Year")) |>
   select(any_of(c("PartyAb","Percentage_Diff_National","cluster")),
          starts_with("Dim")) |>
   pivot_longer(-c("PartyAb","Percentage_Diff_National","cluster"),
                names_to = "Dim",values_to = "value") |>
   filter(!is.na(value)) |>
   filter(PartyAb=="COAL") |>
  filter(Dim ==dim) |>
   ggplot(aes(x=value,y=Percentage_Diff_National,colour=as.character(cluster))) +
   geom_point() +
   scale_x_log10() +
  theme(legend.position = "none") +
  labs(subtitle=dim)
}

p[[length(p)]] <- p[[length(p)]] + theme(legend.position = "bottom")

patchwork::wrap_plots(p,ncol=3)  + patchwork::plot_annotation(title="COAL")

p <- list()
for(dim in str_c("Dim.",1:10)){
 p[[length(p)+1]] <-  transformed |>
 separate(unique_id,c("DivisionNm","Year"),"-") |>
  mutate(Year = as.numeric(Year)) |>
  left_join(dataset |> select(any_of(non_predictors)),
            by=c("DivisionNm","Year")) |>
   select(any_of(c("PartyAb","Percentage_Diff_National","cluster")),
          starts_with("Dim")) |>
   pivot_longer(-c("PartyAb","Percentage_Diff_National","cluster"),
                names_to = "Dim",values_to = "value") |>
   filter(!is.na(value)) |>
   filter(PartyAb=="ALP") |>
  filter(Dim ==dim) |>
   ggplot(aes(x=value,y=Percentage_Diff_National,colour=as.character(cluster))) +
   geom_point() +
   scale_x_log10() +
  theme(legend.position = "none") +
  labs(subtitle=dim)
}

p[[length(p)]] <- p[[length(p)]] + theme(legend.position = "bottom")

patchwork::wrap_plots(p,ncol=3)  + patchwork::plot_annotation(title="ALP")


p <- list()
for(dim in str_c("Dim.",1:10)){
 p[[length(p)+1]] <- transformed |>
 separate(unique_id,c("DivisionNm","Year"),"-") |>
  mutate(Year = as.numeric(Year)) |>
  left_join(dataset |> select(any_of(non_predictors)),
            by=c("DivisionNm","Year")) |>
   select(any_of(c("PartyAb","Percentage_Diff_National","cluster")),
          starts_with("Dim")) |>
   pivot_longer(-c("PartyAb","Percentage_Diff_National","cluster"),
                names_to = "Dim",values_to = "value") |>
   filter(!is.na(value)) |>
   filter(PartyAb=="GRN") |>
  filter(Dim ==dim) |>
   ggplot(aes(x=value,y=Percentage_Diff_National,colour=as.character(cluster))) +
   geom_point() +
   scale_x_log10() +
  theme(legend.position = "none") +
  labs(subtitle=dim)
}

p[[length(p)]] <- p[[length(p)]] + theme(legend.position = "bottom")

patchwork::wrap_plots(p,ncol=3) + patchwork::plot_annotation(title="GRN")


```

```{r}
 just_predictors |>
  drop_na()|>
  add_column(cluster=db$cluster) |>
  rownames_to_column("unique_id") |>
 separate(unique_id,c("DivisionNm","Year"),"-") |>
  mutate(Year = as.numeric(Year)) |>
  left_join(dataset |> select(any_of(non_predictors)) ,
            by=c("DivisionNm","Year")) |> 
   pivot_longer(-c("PartyAb","Percentage_Diff_National","cluster","DivisionNm","Year","StateAb","census_years"),
                names_to = "Dim",values_to = "value") |>
   filter(!is.na(value)) |>
   filter(!is.na(PartyAb)) |>
   ggplot(aes(x=value,y=Percentage_Diff_National,colour=as.character(cluster))) +
   geom_point() +
   facet_grid(PartyAb ~ Dim) +
   scale_x_log10()
```

```{r}
pairs(transformed |>  select(-any_of(c(non_predictors,"unique_id"))), col = db$cluster + 1L)

```

```{r}
db <- dbscan::dbscan(just_predictors  |> drop_na(),eps = 0.3, minPts = 4)
db
```

## Factor Analysis

```{r}
FactoMineR::
```
