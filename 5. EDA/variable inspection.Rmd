---
title: "Filtering correlations"
output: html_notebook
---

Quick notes about looking at all preselected demographic variables.
Corelations calculated using *bulk_run.R*

```{r}
library(tidyverse)
library(here)
library(glue)
library(DBI)
```

```{r}
processed_db <- dbConnect(duckdb::duckdb(), here("4. Data","processed_data.duckdb"),read_only=FALSE)

```


First, we will inspect variables per group (e.g Age), to see if there are obvious correlations between them, as an initial filter. The categories are:

```{r}

categories
```

Source tables:

```{r}
dbListTables(processed_db)
```


## Age

```{r echo=FALSE, message=FALSE, warning=FALSE}
tbl(processed_db,"age_and_sex") |>
  filter(Year!=2021) |>
  select(Year,Unit,Attribute,Percentage) |>
  collect() |>
  pivot_wider(names_from="Attribute",values_from = "Percentage") |>
  select(-Unit,-Year) |>
  relocate(any_of(c("Age - Silent Gen","","Age - Baby Boomers","Age - Gen X","Age - Gen Y","Age - Gen Z","Age - Gen Alpha"))) |>
  GGally::ggpairs()
  
```


```{r}

tbl(processed_db,"age_and_sex") |>
  filter(Year!=2021) |>
  ggplot(aes(x=Percentage,y=fct_relevel(Attribute,
                                        c("Age - Silent Gen","Age - Baby Boomers","Age - Gen X","Age - Gen Y","Age - Gen Z","Age - Gen Alpha")))) +
  geom_violin() +
  facet_grid(.~Year) +
  theme(axis.title.y = element_blank()) +
   scale_x_continuous("Percentage of Electorate's Population"
                      )
  #geom_histogram()+
  #facet_grid( Year ~ fct_relevel(Attribute,c("Age - Silent Gen")))

```

```{r}
tbl(processed_db,"primary_vote") |>
  select(Year,DivisionNm,PartyAb,Percentage_Diff_National) |>
  left_join(tbl(processed_db,"year_equivalency"),by=c("Year"="election_years")) |>
  left_join(tbl(processed_db,"age_and_sex"), by=c("DivisionNm"="Unit","census_years"="Year")) |>
  filter(census_years!=2021)|>
  ggplot(aes(y=Percentage,x=Percentage_Diff_National,colour=as_factor(Year)))+
  geom_point()+
  facet_grid(fct_relevel(Attribute,c("Age - Silent Gen","Age - Baby Boomers","Age - Gen X","Age - Gen Y","Age - Gen Z","Age - Gen Alpha"))~PartyAb)+
  labs(x="Population Percentage",y="Primary Vote Percentage")
  
  


```



- Gen Alpha does not vote yet - Their influence can be captured through houselhold structure.
- Very negative correlation